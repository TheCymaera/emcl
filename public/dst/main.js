!function(){"use strict";class e{constructor(e){this.index=0,this.config=e,this.reset()}reset(){return this.state=this.config.startState,this.index=0,this}currentRules(){return this.config.states.get(this.state)}step(e){const t=this.currentRules();t.regex.lastIndex=this.index;const s=t.regex.exec(e);if(!s)return this.config.errorHandler.call(this,e);for(let e=1;e<s.length;e++)if(void 0!==s[e])return this._transition(s[e],t.transitions[e-1]);throw new Error("LEXER: Encountered an unexpected error.")}tokenize(e){const t=[];for(;this.index<e.length;)t.push(this.step(e));return t}static joinAdjacentTokens(e,t){const s=[];for(const n of e){const e=s[s.length-1];n.type===t&&e?.type===t?e.value+=n.value:s.push(n)}return s}static getTokensMap(e){const t=new Map;let s=0,n=0;for(const r of e){t.set(r,{line:s,char:n}),n+=r.value.length;const e=r.value.split("\n");e.length>1&&(s+=e.length-1,n=e[e.length-1].length)}return t}_transition(e,t){const s=t.call(this,e);return this.index+=e.length,{value:e,type:s}}}class t{constructor(e="start"){this.states=new Map,this.errorHandler=function(e){return{type:"ILLEGAL",value:e[this.index++]}},this.startState=e}define(e,t,s=this.startState){s=Array.isArray(s)?s:[s],t=Array.isArray(t)?t:[t];const n=[];for(const s of t){const t="string"==typeof s?s:s.source;n.push([t,"string"==typeof e?()=>e:e])}for(const e of s){const t=this.states.get(e);t?t.push(...n):this.states.set(e,[...n])}}defineString(e,s,n){const r=(Array.isArray(s)?s:[s]).map((e=>t.stringRegex(e)));return this.define(e,r,n)}buildConfig(){const e={startState:this.startState,states:new Map,errorHandler:this.errorHandler};for(const[s,n]of this.states)e.states.set(s,t.buildState(n));return e}build(){return new e(this.buildConfig())}static stringRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static unionRegex(e){return"("+[...e].join(")|(")+")"}static buildState(e){const s=[],n=[];for(const[t,r]of e)s.push(t),n.push(r);return{regex:new RegExp(t.unionRegex(s),"gy"),transitions:n}}static StaticTransition(e,t){return function(){return this.state=t,e}}}const s=new t;s.define("WHITESPACE",/[^\S\r\n]+|(?:\r?\n)/),s.define("COMMENT",/\/\/.*/),s.define("COMMENT",/\/\*[^]+?\*\//),s.define((e=>{switch(e){case"mcfunction":return"MCFUNCTION";case"mccommand":return"MCCOMMAND";case"mcsubcommand":return"MCSUBCOMMAND";case"score":return"SCORE";case"nbt":return"NBT";case"alias":return"ALIAS";case"import":return"IMPORT";case"for":return"FOR";case"while":return"WHILE";case"if":case"execute":return"EXECUTE";case"const":return"CONST";case"int":case"float":case"bool":case"void":case"string":case"char":return"TYPE"}return"IDENTIFIER"}),/[a-zA-Z_][a-zA-Z0-9_]*/),s.define("STRING_LITERAL",/"(?:\\.|[^\\"])*"/),s.define("STRING_LITERAL",/'(?:\\.|[^\\'])*'/),s.define("FLOAT_LITERAL",/(?:\d*\.\d+)f?/),s.define("DOUBLE_LITERAL",/(?:\d*\.\d+)d?/),s.define("BOOLEAN_LITERAL",/(?:true)|(?:false)/),s.define("INT_LITERAL",/\d+/),s.define("MCCOMMENT_LITERAL",/#[^\n;]+/),s.define("MCCOMMAND_LITERAL",/\/\w[^\n;]+/);for(const e of[";",",",":","{","}","(",")","[","]"])s.defineString(e,e);s.defineString("COMPOUND_ASSIGNMENT_OPERATOR",["+=","-=","*=","/=","%="]),s.defineString("INC_OPERATOR",["++","--"]),s.defineString("MULTIPLICATIVE_OPERATOR",["*","/","%"]),s.defineString("ADDITIVE_OPERATOR",["+","-"]),s.defineString("RELATIONAL_OPERATOR",["<=",">=","<",">"]),s.defineString("EQUALITY_OPERATOR",["==","!="]),s.defineString("AND_OPERATOR","&&"),s.defineString("OR_OPERATOR","||"),s.defineString("ASSIGNMENT_OPERATOR","=");const n=s.build();class r{constructor(e){this.stateStack=[],this.config=e}state(){return this.stateStack[this.stateStack.length-1]||0}reset(){this.stateStack.length=0}next(e,t=[]){const s=t.length,n=[...this.stateStack];for(;;){const r=this.step(e);if(!r)return this.stateStack=n,void(t.length=s);if(t.push(r),2===r.type||0===r.type)return t}}endOfInput(e=[]){return this.next(this.config.endOfInput,e)}step(e){const t=this.config.actionTable[this.state()]?.get(e);if(t)switch(t.type){case 2:return t;case 0:return this.stateStack.push(t.n),t;case 1:{const{lhs:e,rhs:{length:s}}=this.config.rules[t.n];this.stateStack.splice(-s,s);const n=this.config.gotoTable[this.state()].get(e);if(void 0===n)return;return this.stateStack.push(n),t}}}}!function(e){var t;(t=e.ActionType||(e.ActionType={}))[t.SHIFT=0]="SHIFT",t[t.REDUCE=1]="REDUCE",t[t.ACCEPT=2]="ACCEPT"}(r||(r={}));class i{constructor(e){this.stack=[],this.config=e}reset(){return this.stack.length=0,this}step(e,t){if(0===e.type)return this.stack.push(t),!0;{const{rhs:{length:t}}=this.config.rules[e.n],s=this.stack.splice(-t,t),n=this.config.nodeConstructors[e.n](s);return this.stack.push(n),!1}}buildTree(e,t){let s=0;for(const n of e)this.step(n,t[s])&&s++;return this.stack[0]}}class o{constructor(){this._rules=[],this._nonTerminals=new Set,this._nodes=new Set,this._nodeConstructors=[]}define(e,t,s){this._rules.push({lhs:e,rhs:t}),this._nonTerminals.add(e),this._nodes.add(e);for(const e of t)this._nodes.add(e);this._nodeConstructors.push(s||(1===t.length?o.REDUCE_FIRST:o.REDUCE_ARRAY))}defineQuantity(e,t,s){this.define(e,new Array(s).fill(t))}defineZeroOrMore(e,t){this.defineMinQuantity(e,t,0)}defineOneOrMore(e,t){this.defineMinQuantity(e,t,1)}defineMinQuantity(e,t,s){this.defineQuantity(e,t,s),this.define(e,[e,t],(([e,t])=>(e.push(t),e)))}defineDelimitedList(e,t,s){this.define(e,[t]),this.define(e,[e,s,t],(([e,,t])=>(e.push(t),e)))}buildParserConfig(e,t){const s=[],n=[],r=[this._startItemSet(e)];for(let i=0;i<r.length;i++){const o=r[i],a=new Map;for(const[e,t]of this._nextItemSets(o)){let s=f(r,t);-1===s&&(s=r.push(t)-1),a.set(e,s)}s[i]=new Map,n[i]=new Map;for(const r of o){const o=this._itemLookahead(r);if(void 0===o){const n=c(r),o={type:1,n:n};s[i].set(t,o);for(const e of this._nodes)this._nonTerminals.has(e)||s[i].set(e,o);this._rules[n].lhs===e&&s[i].set(t,{type:2,n:n})}else{const e=a.get(o);this._nonTerminals.has(o)?n[i].set(o,e):s[i].set(o,{type:0,n:e})}}}return{actionTable:s,gotoTable:n,rules:[...this._rules],endOfInput:t}}buildTreeBuilderConfig(){return{rules:[...this._rules],nodeConstructors:[...this._nodeConstructors]}}buildParser(e,t){return new r(this.buildParserConfig(e,t))}buildTreeBuilder(){return new i(this.buildTreeBuilderConfig())}debug_itemString(e){const t=this._rules[c(e)],s=l(e);return t.lhs+" => "+t.rhs.slice(0,s).join(" ")+"."+t.rhs.slice(s).join(" ")}static REDUCE_NTH(e){return t=>t[e]}_itemLookahead(e){return this._rules[c(e)].rhs[l(e)]}_completeClosure(e){for(const t of e){const s=this._itemLookahead(t);if(void 0!==s&&this._nonTerminals.has(s))for(let t=0;t<this._rules.length;t++)this._rules[t].lhs===s&&e.add(a(t,0))}return e}_startItemSet(e){const t=new Set;for(let s=0;s<this._rules.length;s++)this._rules[s].lhs===e&&t.add(a(s,0));return this._completeClosure(t)}_nextItemSets(e){const t=new Map;for(const s of e){const e=this._itemLookahead(s);if(!e)continue;const n=t.get(e)||new Set;t.has(e)||t.set(e,n),n.add(h(s))}for(const e of t.values())this._completeClosure(e);return t}}function a(e,t=0){return`${e}.${t}`}function c(e){return parseInt(e.slice(0,e.indexOf(".")))}function l(e){return parseInt(e.slice(e.indexOf(".")+1))}function h(e){return a(c(e),l(e)+1)}function u(e,t){if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0}function f(e,t){for(let s=0;s<e.length;s++){if(u(e[s],t))return s}return-1}o.REDUCE_FIRST=e=>e[0],o.REDUCE_ARRAY=e=>e;class d{async compileAsSubcommands(e){const t=await this.compile(e);return t.type.toSubcommands(e,t.address)}}class p{_(){}}class m{constructor(e,t){this.final=e,this.constant=t}cast(e,t,s){const n=`Cannot cast ${this.displayName()} to ${t.displayName()}.`;throw e.semanticError(n)}binaryOp(e,t,s,n){const r=`${t.type.displayName()} ${s} ${n.type.displayName()} is not a valid operation`;throw e.semanticError(r)}}class g extends d{constructor(e,t){super(),this.type=e,this.address=t}cast(e,t){if(this.type.sameAs(t))return this;const s=this.type.cast(e,t,this.address);return new g(t,s)}async compile(){return this}}class w{constructor(e){this.subcommands=e}}class y{constructor(e){this.value=e}serialize(){return`${this.value}`}sameAs(e){return e instanceof y&&this.value===e.value}toStoreValue(e){return e.toScore(this).toStoreValue()}static is(e,t){return e instanceof y&&e.value===t}}class _{constructor(e){this.id=e}serialize(){return this.id}sameAs(e){return e instanceof _&&this.id===e.id}toStoreTarget(e){return e.toScore(this).toStoreTarget()}toStoreValue(e){return e.toScore(this).toStoreValue()}}class b{constructor(e,t){this.objective=e,this.target=t}serialize(){return`score ${JSON.stringify(this.objective)} ${JSON.stringify(this.target)}`}sameAs(e){return e instanceof b&&this.fragment()===e.fragment()}isStatic(){return"@"!==this.target[0]}isLocallyStatic(){return this.isStatic()||"@p"===this.target||"@s"===this.target||"@a"===this.target||"@e"===this.target}fragment(){return`${this.target} ${this.objective}`}toStoreTarget(){return`score ${this.fragment()}`}toStoreValue(){return`run scoreboard players get ${this.fragment()}`}}class T{constructor(e,t){this.source=e,this.scale=t}sameAs(e){return e instanceof T&&e.source.sameAs(this.source)}serialize(){return`${this.source.serialize()} * ${this.scale}`}toStoreTarget(){return`${this.source.fragment()} ${this.source.dataType} ${1/this.scale}`}toStoreValue(){return`${this.source.toStoreValue()} ${this.scale}`}}class v{constructor(e,t,s,n="unknown"){this.kind=e,this.target=t,this.path=s,this.dataType=n}sameAs(e){return e.kind===this.kind&&e.target===this.target&&e.path===this.path&&e.dataType===this.dataType}serialize(){return`nbt ${JSON.stringify(this.kind)} ${JSON.stringify(this.target)} ${JSON.stringify(this.path)}`}fragment(){return`${this.kind} ${this.target} ${this.path}`}toStoreValue(){return`run data get ${this.fragment()}`}}class S{constructor(e,t,s){this.lhs=e,this.op=t,this.rhs=s}serialize(){return`${this.lhs.serialize()} ${this.op} ${this.rhs.serialize()}`}flip(){switch(this.op){case"<":return new S(this.rhs,">",this.lhs);case">":return new S(this.rhs,"<",this.lhs);case"<=":return new S(this.rhs,">=",this.lhs);case">=":return new S(this.rhs,"<=",this.lhs);case"==":return new S(this.rhs,"==",this.lhs);case"!=":return new S(this.rhs,"!=",this.lhs)}}toSubcommand(e){if(this.lhs instanceof y&&!(this.rhs instanceof y))return this.flip().toSubcommand(e);const t=e.toScore(this.lhs);if(!(this.rhs instanceof y)){const s=e.toScore(this.rhs);if("!="===this.op)return`unless score ${t.fragment()} = ${s.fragment()}`;const n="=="===this.op?"=":this.op;return`if score ${t.fragment()} ${n} ${s.fragment()}`}{const e=0|this.rhs.value;switch(this.op){case"<":return`if score ${t.fragment()} matches ..${e-1}`;case"<=":return`if score ${t.fragment()} matches ..${e}`;case">":return`if score ${t.fragment()} matches ${e}..`;case">=":return`if score ${t.fragment()} matches ${e+1}..`;case"==":return`if score ${t.fragment()} matches ${e}`;case"!=":return`unless score ${t.fragment()} matches ${e}`}}}toStoreValue(e){return this.toSubcommand(e)}}class E{constructor(e){this.subcommand=e}serialize(){return"mcsubcommand "+JSON.stringify(this.subcommand)}toSubcommand(){return this.subcommand}}class x{constructor(e,t){this.dst=e,this.src=t}serialize(){return this.src instanceof C&&this.dst.sameAs(this.src.lhs)?this.dst.serialize()+` ${this.src.op}= `+this.src.rhs.serialize():this.dst.serialize()+" = "+this.src.serialize()}toCommand(e){if(this.dst instanceof T&&this.src instanceof T&&this.dst.scale===this.src.scale)return[`data modify ${this.dst.source.fragment()} set from ${this.src.source.fragment()}`];if(this.dst instanceof b||this.dst instanceof _){const t=e.toScore(this.dst);if(this.src instanceof b||this.src instanceof _){const s=e.toScore(this.src);return[`scoreboard players operation ${t.fragment()} = ${s.fragment()}`]}if(this.src instanceof y)return[`scoreboard players set ${t.fragment()} ${0|this.src.value}`]}if(this.src instanceof C){if(this.dst instanceof b||this.dst instanceof _)return this.src.writeTo(e,this.dst);const t=e.ac();return[...this.src.writeTo(e,t),...new x(this.dst,e.ac()).toCommand(e)]}return[`execute store result ${this.dst.toStoreTarget(e)} ${this.src.toStoreValue(e)}`]}}class C{constructor(e,t,s){this.lhs=e,this.op=t,this.rhs=s}serialize(){return`${this.lhs.serialize()} ${this.op} ${this.rhs.serialize()}`}writeTo(e,t){const s=[];return t.sameAs(this.lhs)||s.push(...new x(t,this.lhs).toCommand(e)),s.push(...new I(t,this.op,this.rhs).toCommand(e)),s}}class O{constructor(e,t){this.subcommands=e,this.block=t}serialize(){const e=`/function ${this.block}`;return this.subcommands.length?`if (${this.subcommands.map((e=>e.serialize())).join(" && ")}) ${e}`:e}toCommand(e){const t=e.generateBlock(this.block),s=this.subcommands.map((t=>O._toSubcommand(t).toSubcommand(e)));return s.length?[`execute ${s.join(" ")} run ${t}`]:[t]}static _toSubcommand(e){return e instanceof E||e instanceof S?e:new S(e,"!=",new y(0))}}class A{constructor(e){this.command=e}isComment(){return"#"===this.command[0]}serialize(){return this.isComment()?this.command:"/"+this.command}toCommand(){return[this.command]}}class I{constructor(e,t,s){this.dst=e,this.op=t,this.src=s}toCommand(e){const t=this.normalize(),s=e.toScore(t.dst);if(t.src instanceof y){let e="";switch(t.op){case"=":e="set";break;case"+":e="add";break;case"-":e="remove"}if(e)return[`scoreboard players ${e} ${s.fragment()} ${0|t.src.value}`]}const n=e.toScore(t.src);return[`scoreboard players operation ${s.fragment()} ${I._assignmentOp(t.op)} ${n.fragment()}`]}serialize(){return`${this.dst.serialize()} ${I._assignmentOp(this.op)} ${this.src.serialize?.()||this.src}`}normalize(){if(this.src instanceof y&&0<this.src.value&&this.src.value<1)switch(this.op){case"+":return new I(this.dst,"-",new y(-this.src.value));case"-":return new I(this.dst,"+",new y(-this.src.value));case"*":return new I(this.dst,"/",new y(1/this.src.value));case"/":return new I(this.dst,"*",new y(1/this.src.value))}return this}static _assignmentOp(e){return"="===e?e:e+"="}}class R{constructor(){this.blocks=new Map}generate(){const e=new $(this);for(const[t]of this.blocks)"_"!==t[0]&&e.generateBlock(t);return e}clone(){const e=new R;return e.blocks=new Map(this.blocks),e}}class ${constructor(e){this.program=e,this.mcfunctions=new Map,this.scores=new Set,this._createObjective=!1,this._constantScores=new Map,this._generated=new Map}ac(){return this._createObjective=!0,new b(this._objective(),"AC")}toScore(e){const t=t=>{for(const t of this.scores)t.sameAs(e)&&this.scores.delete(t);return this.scores.add(t),t};if(e instanceof b)return t(e);if(e instanceof _){const s=new b(this._objective(),"T_"+e.id);return this._createObjective=!0,t(s)}if(e instanceof y){const s=Math.round(e.value),n=new b(this._objective(),"C_"+s);return this._createObjective=!0,this._constantScores.set(s,n),t(n)}throw new Error(`Cannot convert ${e} to score`)}generateBlock(e){const t=this._functionName(e);if(this._generated.has(e)){const s=this._generated.get(e);return 1===s.length?s[0]:`function ${t}`}const s=this.program.blocks.get(e);if(!s)return`function ${t}`;this._generated.set(e,[]);const n=s.map((e=>e.toCommand(this))).flat(1);return this._generated.set(e,n),"_"===e[0]&&1===n.length||this.mcfunctions.set(t,n),this.generateBlock(e)}files(){const e=new Map(this.mcfunctions),t=e.get(this.program.config.initializer)||[],s=e.get(this.program.config.destructor)||[];t.unshift(...this.initializer()),s.push(...this.destructor()),e.set(this.program.config.initializer,t),e.set(this.program.config.destructor,s);const n=new Map;for(const[t,s]of e){const[e,r]=t.split(":"),i=`data/${e}/functions/${r}.mcfunction`;n.set(i,s.join("\n"))}return n}initializer(){const e=[];this._createObjective&&e.push(`scoreboard objectives add ${this._objective()} dummy "MIL Internal"`);for(const[t,s]of this._constantScores)e.push(`scoreboard players set ${s.target} ${this._objective()} ${t}`);return e}destructor(){return this._createObjective?[`scoreboard objectives remove ${this._objective()}`]:[]}_objective(){return this.program.config.scoreboardNamespace+"r"}_functionName(e){return"_"===e[0]?this.program.config.functionNamespace+e.slice(1):e}}const L=/[^a-z\d_\-\/\.:]/g;function k(e){const t=e.split(":"),s=[];if(2!==t.length&&s.push('Namespaced ids should have the format "namespace:id".'),t[0].includes("/")&&s.push("Namespaces cannot contain slashes."),e.match(L)&&(e.toLowerCase()!==e?s.push("Namespaced ids cannot contain uppercase letters."):s.push("Namespaced id contains illegal characters.")),s.length)return`"${e}" is not a valid namespaced id.\n`+s.join("\n")}const M=/[^\w\-\+\.]/g;function N(e){let t=[];if(e.length>16&&t.push("Scoreboard objectives can contain at most 16 characters."),e.match(M)&&t.push("Objective contains illegal characters."),t.length)return`"${e}" is not a valid scoreboard objective name.\n`+t.join("\n")}function F(e){if(e.lhs instanceof y&&e.rhs instanceof y)switch(e.op){case"<":return new y(+(e.lhs.value<e.rhs.value));case"<=":return new y(+(e.lhs.value<=e.rhs.value));case"==":return new y(+(e.lhs.value===e.rhs.value));case">=":return new y(+(e.lhs.value>=e.rhs.value));case">":return new y(+(e.lhs.value>e.rhs.value));case"!=":return new y(+(e.lhs.value!=e.rhs.value))}return e.lhs instanceof y&&!(e.rhs instanceof y)?e.flip():e.lhs.sameAs(e.rhs)?new y(+["<=","==",">="].includes(e.op)):void 0}function P(e){return e instanceof x?function(e){if(e.dst.sameAs(e.src))return;let t;e.src instanceof C&&(t=function(e){if(e.lhs instanceof y&&e.rhs instanceof y)switch(e.op){case"+":return new y(e.lhs.value+e.rhs.value);case"-":return new y(e.lhs.value-e.rhs.value);case"*":return new y(e.lhs.value*e.rhs.value);case"/":return new y(e.lhs.value/e.rhs.value);case"%":return new y(e.lhs.value%e.rhs.value)}if(e.lhs instanceof y&&!(e.rhs instanceof y))switch(e.op){case"+":return new C(e.rhs,"+",e.lhs);case"-":return new C(e.rhs,"+",new y(-e.lhs.value));case"*":return new C(e.rhs,"*",e.lhs);case"-":return new C(e.rhs,"*",new y(1/e.lhs.value))}if("+"===e.op&&y.is(e.rhs,0))return e.lhs;if("*"===e.op){if(y.is(e.rhs,1))return e.lhs;if(y.is(e.rhs,0))return new y(0);if(y.is(e.rhs,2))return new C(e.lhs,"+",e.lhs)}if("-"===e.op){if(y.is(e.rhs,0))return e.lhs;if(e.lhs.sameAs(e.rhs))return new y(0)}if("/"===e.op){if(y.is(e.rhs,0))return new y(0);if(y.is(e.rhs,1))return e.lhs;if(e.lhs.sameAs(e.rhs))return new y(1)}if("%"===e.op){if(e.lhs.sameAs(e.rhs))return new y(0);if(y.is(e.rhs,1))return new y(0)}}(e.src));e.src instanceof S&&(t=F(e.src));return t?new x(e.dst,t):e}(e):e instanceof O?function(e){let t=!1;const s=[];for(const n of e.subcommands)if(n instanceof S){const e=F(n);s.push(e||n),e&&(t=!0)}else if(n instanceof y){if(0===n.value)return;if(0!==n.value){t=!0;continue}s.push(n)}return t?new O(s,e.block):e}(e):e}function z(e){for(let t=0;t<e.length;t++){const s=e[t],n=e[t+1];if(!s||!n)return false;const r=j(s,n);r&&e.splice(t,2,r)}return false}function j(e,t){if(e instanceof x&&t instanceof x){if(!e.dst.sameAs(t.dst))return;if(!(e.src instanceof C))return;if(!(t.src instanceof C))return;if(!t.dst.sameAs(t.src.lhs))return;if(!(e.src.rhs instanceof y))return;if(!(t.src.rhs instanceof y))return;if(function(e,t){if(!("+"!==e&&"-"!==e||"+"!==t&&"-"!==t))return!0;if(!("*"!==e&&"/"!==e||"*"!==t&&"/"!==t))return!0;return!1}(e.src.op,t.src.op))return new x(e.dst,new C(e.src.lhs,e.src.op,function(e,t,s){switch(t){case"+":return new y(e.value+s.value);case"-":return new y(e.value-s.value);case"*":return new y(e.value*s.value);case"/":return new y(e.value/s.value);case"%":return new y(e.value%s.value)}}(e.src.rhs,t.src.op,t.src.rhs)))}}class D{constructor(){this._values=new Map}set(e,t){this.remove(e),this._values.set(e,t)}has(e){for(const[t,s]of this._values)if(e.sameAs(t))return!0;return!1}get(e){for(const[t,s]of this._values)if(e.sameAs(t))return s}remove(e){this.filter((t=>!e.sameAs(t)))}filter(e){for(const[t,s]of this._values){e(t,s)||this._values.delete(t)}}clear(){this._values.clear()}debug_table(){const e={};for(const[t,s]of this._values)e[t.serialize()]="serialize"in s?s.serialize():`${s}`;return e}get size(){return this._values.size}}function U(e){const t=new D;for(const[s,n]of e.blocks)for(const e of n){const s=H(e);for(const e of s)t.set(e,(t.get(e)||0)+1)}return t}function H(e){if(e instanceof x)return H(e.src);if(e instanceof _)return[e];if(e instanceof S||e instanceof C)return[...H(e.lhs),...H(e.rhs)];if(e instanceof O){const t=[];for(const s of e.subcommands)t.push(...H(s));return t}return[]}function V(e,t){const s=[];let n=!1;for(const r of e)r instanceof x&&r.dst instanceof _&&!t.get(r.dst)?n=!0:s.push(r);return n?s:e}function G(e,t,s){const n=B(e,t,s);return function(e,t){if(e instanceof x)return void((e.dst instanceof b&&e.dst.isLocallyStatic()||e.dst instanceof _)&&(t.filter(((t,s)=>!t.sameAs(e.dst)&&!q(s,e.dst))),(e.src instanceof b&&e.src.isLocallyStatic()||e.src instanceof _||e.src instanceof S||e.src instanceof C||e.src instanceof y)&&(q(e.src,e.dst)||t.set(e.dst,e.src))));if(e instanceof A&&e.isComment())return;t.clear()}(e,t),n||e}function B(e,t,s){if(e instanceof b)return t.get(e);if(e instanceof _)return t.get(e);if(e instanceof x)if(e.src instanceof b||e.src instanceof _){const n=1===s.get(e.src)?t.get(e.src):W(t,e.src);if(n)return new x(e.dst,n)}else{const n=B(e.src,t,s);if(n)return new x(e.dst,n)}if(e instanceof S){const s=W(t,e.lhs),n=W(t,e.rhs);if(s||n)return new S(s||e.lhs,e.op,n||e.rhs)}if(e instanceof C){const s=W(t,e.lhs),n=W(t,e.rhs);if(s||n)return new C(s||e.lhs,e.op,n||e.rhs)}if(e instanceof O){const n=[];let r=!1;for(const i of e.subcommands){const e=B(i,t,s);e instanceof b||e instanceof _||e instanceof S||e instanceof y?(n.push(e),r=!0):n.push(i)}if(r)return new O(n,e.block)}}function W(e,t){const s=e.get(t);if(!(s instanceof S||s instanceof C))return s}function q(e,t){return!(e instanceof y)&&(!(t instanceof y)&&(e instanceof S||e instanceof C?q(e.lhs,t)||q(e.rhs,t):e.sameAs(t)))}function J(e){let t=!1;return t=function(e){let t=!1;const s=U(e);for(const[n,r]of e.blocks){const i=new D,o=[];e.blocks.set(n,o);for(const e of r){const n=G(e,i,s);o.push(n),e!==n&&(t=!0)}}return t}(e)||t,t=function(e){let t=!1;for(const[s,n]of e.blocks){const r=[];for(const e of n){const s=P(e);s&&r.push(s),e!==s&&(t=!0)}e.blocks.set(s,r)}return t}(e)||t,t=function(e){let t=!1;for(const[s,n]of e.blocks)t=z(n)||t;return t}(e)||t,t=function(e){const t=U(e);let s=!1;for(const[n,r]of e.blocks){const i=V(r,t);r!==i&&(s=!0),e.blocks.set(n,i)}return s}(e)||t,t}class Q extends m{constructor(e){super(!1,e),this.constant=e}displayName(){return(this.constant?"const ":"")+"string"}toSubcommands(e,t){return new w([new y(t.value?1:0)])}sameAs(e){return e instanceof Q}alloc(e){return new Y("")}copy(e,t,s){throw e.semanticError("String assignment is not currently supported")}binaryOp(e,t,s,n){return t.address instanceof Y&&n.address instanceof Y&&"+"===s?new g(this,new Y(t.address.value+n.address.value)):super.binaryOp(e,t,s,n)}static constant(e){return new g(new Q(!0),new Y(e))}}class Y extends p{constructor(e){super(),this.value=e}}class Z extends m{constructor(){super(!0,!0)}sameAs(e){return e instanceof Z}displayName(){return"void"}toSubcommands(e){throw e.semanticError("Cannot use void as a condition!")}alloc(){return Z.value()}binaryOp(e,t,s,n){return super.binaryOp(e,t,s,n)}copy(e,t,s){}static value(){return new g(new Z,new X)}}class X extends p{}class K extends m{constructor(){super(!0,!0)}displayName(){return"mcsubcommand"}sameAs(e){return e instanceof K}toSubcommands(e,t){return new w([new E(t.subcommand)])}alloc(){throw new Error("Cannot allocate a mcsubcommand")}copy(e,t,s){throw new Error("Cannot assign to mcsubcommand")}static value(e){return new g(new K,new ee(e))}}class ee extends p{constructor(e){super(),this.subcommand=e}}class te extends d{constructor(e){super(),this.uri=e}async compile(e){if(!e.isGlobal())throw e.semanticError("Import statements can only be used in the global scope.");return await e.importModule(e.moduleURI.clone().appendString(this.uri)),Z.value()}}class se extends d{constructor(e){super(),this.children=e}async compile(e){for(const t of this.children)await t.compile(e);return Z.value()}}class ne extends d{constructor(e,t){super(),this.subcommand=e,this.then=t}async compile(e){const t=await e.compileToNamelessFunction(this.then),s=await this.subcommand.compileAsSubcommands(e);return e.out.push(new O(s.subcommands,t)),Z.value()}}class re extends d{constructor(e,t,s,n,r){super(),this.init=e,this.subcommand=t,this.afterthought=s,this.then=n,this.doWhile=r}async compile(e){await this.init.compile(e);const t=await e.compileToNamelessFunction(this.then);await e.compileToFunction(t,this.afterthought);const s=new ne(this.subcommand,new ie(t));return await e.compileToFunction(t,s),this.doWhile?await s.then.compile(e):await s.compile(e),Z.value()}}class ie extends d{constructor(e){super(),this.name=e}compile(e){return e.out.push(new O([],this.name)),Z.value()}}class oe extends d{constructor(e){super(),this.child=e}async compile(e){const t=await this.child.compile(e);if(!(t.address instanceof Y))throw e.semanticError(`Cannot use "${t.type.displayName()}" as mccommand.`);return e.out.push(new A(t.address.value)),Z.value()}}class ae extends d{constructor(e){super(),this.child=e}async compile(e){const t=await this.child.compile(e);if(!(t.address instanceof Y))throw e.semanticError(`Cannot use "${t.type.displayName()}" as mcsubcommand.`);return K.value(t.address.value)}}class ce extends d{constructor(e){super(),this.child=e}async compile(e){e.enterScope();const t=await this.child.compile(e);return e.exitScope(),t}}class le extends d{constructor(e){super(),this.identifier=e}async compile(e){return e.resolveIdentifier(this.identifier)}}class he extends d{constructor(e,t,s){super(),this.type=e,this.identifier=t,this.initializer=s}async compile(e){const t=this.type.alloc(e,this.identifier),s=(await this.initializer.compile(e)).cast(e,this.type);return this.type.constant?e.defineIdentifier(this.identifier,s):(this.type.copy(e,t,s.address),e.defineIdentifier(this.identifier,new g(this.type,t))),Z.value()}}class ue extends d{constructor(e,t){super(),this.identifier=e,this.value=t}async compile(e){const t=await this.value.compile(e);return e.defineIdentifier(this.identifier,t),Z.value()}}class fe extends d{constructor(e,t){super(),this.namespacedId=e,this.block=t}async compile(e){return await e.compileToFunction(this.namespacedId,this.block),Z.value()}}class de extends p{constructor(e){super(),this.address=e}}class pe extends p{constructor(e){super(),this.address=e}}class me extends m{constructor(e,t=!1,s=!1){super(t,s),this.resolution=e,this.final=t,this.constant=s}displayName(){let e=`float<${this.resolution}>`;return this.resolution===me.INT&&(e="int"),this.resolution===me.FLOAT&&(e="float"),(this.constant?"const ":"")+e}sameAs(e){return e instanceof me&&this.resolution===e.resolution}toSubcommands(e,t){const s=this._toMIL(this._constantOrScore(e,t));return new w([s])}alloc(e,t){return new de(e.createTemporary(t))}copy(e,t,s){e.out.push(new x(this._toMIL(t),this._toMIL(s)))}cast(e,t,s){if(t instanceof me){if(s instanceof ge)return s;if(s instanceof pe)return s;if(s instanceof de){const n=this.alloc(e),r=new C(s.address,"*",new y(t.resolution/this.resolution));return e.out.push(new x(n.address,r)),n}}return super.cast(e,t,s)}binaryOp(e,t,s,n){const r=Math.max(this.resolution,n.type instanceof me?n.type.resolution:this.resolution),i=new me(r),o=this._constantOrScore(e,t.cast(e,i).address),a=this._constantOrScore(e,n.cast(e,i).address),c=i.alloc(e);if("<"===s||"<="===s||"=="===s||">="===s||">"===s||"!="===s){const t=new S(i._toMIL(o),s,i._toMIL(a));return e.out.push(new x(c.address,t)),new g(i,c)}const l=(e,t,s,n)=>new x(e.address,new C(i._toMIL(t),s,i._toMIL(n)));return"+"===s||"-"===s||"%"===s?(e.out.push(l(c,o,s,a)),new g(i,c)):"*"===s?(e.out.push(l(c,o,s,a)),e.out.push(new x(c.address,new C(i._toMIL(c),"/",new y(r)))),new g(i,c)):"/"===s?(e.out.push(new x(c.address,new C(i._toMIL(o),"*",new y(r)))),e.out.push(l(c,c,s,a)),new g(i,c)):super.binaryOp(e,t,s,n)}static constant(e,t){return new g(new me(t,!0,!0),new ge(e))}_toMIL(e){if(e instanceof de)return e.address;if(e instanceof pe)return new T(e.address,this.resolution);if(e instanceof ge)return new y(e.value*this.resolution);throw new Error("Tried to use an unsupported address type")}_constantOrScore(e,t){if(t instanceof de||t instanceof ge)return t;const s=this.alloc(e);return this.copy(e,s,t),s}}me.INT=1,me.FLOAT=100;class ge extends p{constructor(e){super(),this.value=e}}class we extends d{constructor(e,t,s){super(),this.lhs=e,this.op=t,this.rhs=s}async compile(e){const t=await this.lhs.compile(e),s=await this.rhs.compile(e);return t.type.binaryOp(e,t,this.op,s)}static negative(e){return new we(me.constant(0,1),"-",e)}static not(e){return new we(e,"!=",me.constant(0,1))}}class ye extends d{constructor(e,t){super(),this.lhs=e,this.rhs=t}async compile(e){const t=await this.lhs.compile(e),s=await this.rhs.compile(e),n=s.cast(e,t.type);return t.type.copy(e,t.address,n.address),s}static compound(e,t,s){return new ye(e,"="===t?s:new we(e,t[0],s))}static inc(e){return this.compound(e,"+=",me.constant(1,1))}static dec(e){return this.compound(e,"+=",me.constant(1,1))}}const _e=new o;_e.define("string",["STRING_LITERAL"],(([e])=>{return(t=e).slice(1,t.length-1).replace(/\\(u[0-9a-fA-F]{4}|[^u])/,((e,t)=>{const s=t.charAt(0);if("u"===s)return String.fromCharCode(parseInt(t.slice(1),16));switch(s){case"b":return"\b";case"f":return"\f";case"n":return"\n";case"r":return"\r";case"t":return"\t";default:return s}}));var t})),_e.define("int",["INT_LITERAL"],(([e])=>parseInt(e))),_e.define("float",["FLOAT_LITERAL"],(([e])=>parseFloat(e))),_e.define("boolean",["BOOLEAN_LITERAL"],(([e])=>"true"===e)),_e.defineZeroOrMore("statement*","statement"),_e.define("statement*",["statement*",";"],o.REDUCE_FIRST),_e.define("block",["statement*"],(([e])=>new se(e))),_e.define("statement",["MCCOMMENT_LITERAL"],(([e])=>new oe(Q.constant(e)))),_e.define("statement",["IMPORT","string"],(([,e])=>new te(e))),_e.define("statement",["ALIAS","IDENTIFIER","alias_value"],(([,e,t])=>{})),_e.define("statement",["MCCOMMAND_LITERAL"],(([e])=>new oe(e.slice(1)))),_e.define("statement",["MCFUNCTION","string","{","block","}"],(([,e,,t])=>new fe(e,new ce(t)))),_e.define("statement",["FOR","(","terminated_statement","terminated_statement","complete_expression",")","statement"],(([,,e,t,s,,n])=>new ce(new re(e,t,s,n,!1)))),_e.define("statement",["FOR","(","terminated_statement","terminated_statement",")","statement"],(([,,e,t,,s])=>new ce(new re(e,t,Z.value(),s,!1)))),_e.define("statement",["WHILE","(","complete_expression",")","statement"],(([,,e,,t])=>new ce(new re(Z.value(),e,Z.value(),t,!1)))),_e.define("statement",["DO","(","complete_expression",")","WHILE","statement"],(([,,e,,,t])=>new ce(new re(Z.value(),e,Z.value(),t,!0)))),_e.define("statement",["EXECUTE","(","complete_expression",")","statement"],(([,,e,,t])=>new ne(e,t))),_e.define("statement",["EXECUTE","string","statement"],(([,e,t])=>new ne(new ae(Q.constant(e)),t))),_e.define("statement",["complete_expression"],o.REDUCE_FIRST),_e.define("statement",["{","block","}"],(([,e])=>new ce(e))),_e.define("statement",["type","IDENTIFIER","ASSIGNMENT_OPERATOR","complete_expression"],(([e,t,,s])=>new he(e,t,s))),_e.define("statement",["ALIAS","IDENTIFIER","aliasValue"],(([,e,t])=>new ue(e,t))),_e.define("terminated_statement",["statement",";"],o.REDUCE_FIRST),_e.define("complete_expression",["or_expression"]),_e.define("complete_expression",["or_expression","ASSIGNMENT_OPERATOR","complete_expression"],(([e,,t])=>new ye(e,t))),_e.define("complete_expression",["or_expression","COMPOUND_ASSIGNMENT_OPERATOR","complete_expression"],(([e,t,s])=>ye.compound(e,t,s)));const be=([e,t,s])=>new we(e,t,s);_e.define("or_expression",["and_expression"]),_e.define("or_expression",["or_expression","OR_OPERATOR","and_expression"],be),_e.define("and_expression",["equality_expression"]),_e.define("and_expression",["and_expression","AND_OPERATOR","equality_expression"],be),_e.define("equality_expression",["relational_expression"]),_e.define("equality_expression",["equality_expression","EQUALITY_OPERATOR","relational_expression"],be),_e.define("relational_expression",["additive_expression"]),_e.define("relational_expression",["relational_expression","RELATIONAL_OPERATOR","additive_expression"],be),_e.define("additive_expression",["multiplicative_expression"]),_e.define("additive_expression",["additive_expression","ADDITIVE_OPERATOR","multiplicative_expression"],be),_e.define("multiplicative_expression",["unary_expression"]),_e.define("multiplicative_expression",["multiplicative_expression","MULTIPLICATIVE_OPERATOR","unary_expression"],be),_e.define("unary_expression",["primary_expression"]),_e.define("unary_expression",["ADDITIVE_OPERATOR","unary_expression"],(([e,t])=>{if("+"===e)return t;if("-"===e)return we.negative(t);throw new Error(`EMCL Parser: Unsupported prefix op "${e}".`)})),_e.define("unary_expression",["INC_OPERATOR","unary_expression"],(([e,t])=>{if("++"===e)return ye.inc(t);if("--"===e)return ye.dec(t);throw new Error(`EMCL Parser: Unsupported prefix op "${e}".`)})),_e.define("unary_expression",["unary_expression","INC_OPERATOR"],(([e,t])=>{throw new Error(`EMCL Parser: Unsupported postfix op "${t}".`)})),_e.define("unary_expression",["NOT_OPERATOR","unary_expression"],(([,e])=>we.not(e))),_e.define("primary_expression",["(","complete_expression",")"],o.REDUCE_NTH(1)),_e.define("primary_expression",["MCCOMMAND_LITERAL"],(([e])=>new oe(Q.constant(e.slice(1))))),_e.define("primary_expression",["MCCOMMAND","complete_expression"],(([,e])=>new oe(e))),_e.define("primary_expression",["MCSUBCOMMAND","complete_expression"],(([,e])=>new ae(e))),_e.define("primary_expression",["IDENTIFIER"],(([e])=>new le(e))),_e.define("primary_expression",["string"],(([e])=>Q.constant(e))),_e.define("primary_expression",["int"],(([e])=>me.constant(e,me.INT))),_e.define("primary_expression",["float"],(([e])=>me.constant(e,me.FLOAT))),_e.define("primary_expression",["bool"],(([e])=>me.constant(e?1:0,me.INT))),_e.define("primary_expression",["aliasValue"],o.REDUCE_FIRST),_e.define("type",["CONST","type"],(([,e])=>(e.constant=!0,e))),_e.define("type",["TYPE"],(([e])=>{if("int"===e)return new me(me.INT,!1);if("float"===e)return new me(me.FLOAT,!1);if("string"===e)return new Q(!1);throw new Error(`EMCL Parser: Unsupported type "${e}"`)})),_e.define("type",["TYPE","<","int",">"],(([e,t])=>{if("float"===e)return new me(t,!1);throw new Error(`EMCL Parser: Unsupported type "${e}<${t}>"`)})),_e.define("aliasValue",["SCORE","string","string"],(([,e,t])=>{const s=new me(1,!1);return new g(s,new de(new b(e,t)))})),_e.define("aliasValue",["type","SCORE","string","string"],(([e,,t,s])=>new g(e,new de(new b(t,s))))),_e.define("aliasValue",["type","NBT","string","string","string","string"],(([e,,t,s,n,r])=>new g(e,new pe(new v(t,s,n,r)))));const Te=_e.buildParser("block","<EOI>"),ve=_e.buildTreeBuilder();const Se=new Set(["COMMENT","WHITESPACE"]);class Ee{constructor(e="",t="",s=[],n=""){this.scheme=e,this.authority=t,this.directory=s,this.filename=n}static fromString(e){try{return(new Ee).setString(e)}catch(e){return}}setString(e){const t=new URL(e);return this.scheme=t.protocol.slice(0,-1),t.pathname.startsWith("//")?(this.directory=t.pathname.slice(2).split("/"),this.authority=this.directory.shift()||""):(this.directory=t.pathname.slice(1).split("/"),this.authority=t.host),t.pathname.endsWith("/")?this.directory.pop():this.filename=this.directory.pop()||"",this}appendString(e,t){if(e.includes(":/"))return this.setString(e);this.filename="";for(const t of e.split("/"))t&&"."!==t&&(".."===t&&this.directory.pop(),this.directory.push(t));return t||e.endsWith("/")||(this.filename=this.directory.pop()||""),this}set(e){return this.scheme=e.scheme,this.authority=e.authority,this.directory=Array.from(e.directory),this.filename=e.filename,this}setFilename(e){return this.filename=e,this}clone(){return(new Ee).set(this)}stem(){if(this.filename)return this.filename.substring(0,this.filename.lastIndexOf("."))||this.filename}extension(){if(!this.filename)return;const e=this.filename.lastIndexOf(".");return-1===e?"":this.filename.substring(e)}slug(){return this.filename||this.directory[this.directory.length-1]||this.authority}isRoot(){return!this.directory.length&&!this.filename}hasSameRootAs(e){return this.scheme===e.scheme&&this.authority===e.authority}contains(e,t=!1){if(this.filename)return t&&this.isEqualTo(e);if(!this.hasSameRootAs(e))return!1;if(this.directory.length>e.directory.length)return!1;if(!t&&this.directory.length===e.directory.length&&this.filename&&!e.filename)return!1;for(let t=0,s=this.directory.length;t<s;t++)if(this.directory[t]!==e.directory[t])return!1;return!0}isEqualTo(e){if(!this.hasSameRootAs(e))return!1;if(this.directory.length!==e.directory.length)return!1;for(let t=0,s=this.directory.length;t<s;t++)if(this.directory[t]!==e.directory[t])return!1;return this.filename===e.filename}isParentOf(e){return this.directory.length===e.directory.length&&this.contains(e)}toString(e=!0){const t=`${this.scheme}:`+(this.authority?`//${this.authority}`:"")+("/"+(this.directory.length?`${this.directory.join("/")}/`:"")+this.filename);return e?encodeURI(t):t}relativePathOf(e){if(!this.hasSameRootAs(e))return e.toString();let t=this.clone();t.filename="";let s="";for(;!t.contains(e);)s+="../",t.directory.pop();return s+=e.directory.slice(this.directory.length).join("/")+e.filename,s}}function xe(e){return{entry:"main.emcl",destination:"dst",initializer:`${e}:init`,destructor:`${e}:destroy`,scoreboardNamespace:`${e}.i`,functionNamespace:`${e}:internal/`,onLoad:[],onTick:[],packMeta:{pack:{pack_format:7,description:"<ADD DESCRIPTION HERE>"}}}}class Ce{constructor(e,t,s,n,r){this.compiler=e,this.moduleURI=t,this.out=s,this._symbolTable=n,this._temporaries=r}static async entry(e){const t=e.uri.clone().appendString(e.config.entry),s=new Ce(e,t,[],[new Map],new Set);await s.importModule(t),s._appendToFunction(e.config.initializer,s.out)}async importModule(t){const s=t.toString();let r=this.compiler.modules.get(s);if(r)return;this.compiler.console.log(`Reading file: ${this.moduleURI.relativePathOf(t)}`);const i=await this.compiler.fileSystem.readTextFile(t).catch((e=>{throw this.semanticError(e.message)})),o=new Ce(this.compiler,t,this.out,[new Map],this._temporaries);r=function(t,s){n.reset(),Te.reset(),ve.reset();const r=e.joinAdjacentTokens(n.tokenize(s),"ILLEGAL"),i=e.getTokensMap(r),o=[];for(const e of r)if("ILLEGAL"===e.type){const s=i.get(e),n=`Illegal token at: (${s.line}, ${s.char})`;t.compiler.console.error(n)}else Se.has(e.type)||o.push(e);const a=[];for(const e of o)if(!Te.next(e.type,a)){const n=i.get(e),o=`Syntax Error: Unexpected token "${e.value}" at:\nline ${n.line+1}\nchar ${n.char+1}\nfile: ${t.compiler.uri.relativePathOf(t.moduleURI)}`;return t.compiler.console.error(o),{source:s,tokens:r,tokenMap:i,ast:Z.value(),syntaxError:{message:o,tokenIndex:r.indexOf(e)}}}if(!Te.endOfInput(a)){const e="Syntax Error: Unexpected end of input!";return t.compiler.console.error(e),{source:s,tokens:r,tokenMap:i,ast:Z.value(),syntaxError:{message:e,tokenIndex:r.length}}}try{return{source:s,tokens:r,tokenMap:i,ast:ve.buildTree(a,o.map((e=>e.value)))}}catch(e){const n=e.message;return t.compiler.console.error(n),{source:s,tokens:r,tokenMap:i,ast:Z.value(),syntaxError:{message:n,tokenIndex:r.length}}}}(o,i),this.compiler.modules.set(s,r);for(const e of this.compiler.onImportModule)e.call(this,t,r);await r.ast.compile(o)}async compileToNamelessFunction(e){const t=`_branch${this.compiler.program.blocks.size}`;return await this.compileToFunction(t,e),t}async compileToFunction(e,t){const s=new Ce(this.compiler,this.moduleURI,[],this._symbolTable,this._temporaries);this._appendToFunction(e,[]),await t.compile(s),this._appendToFunction(e,s.out)}createTemporary(e="T"){let t=0,s=e;for(;this._temporaries.has(s);)s=`${e}${t++}`;return this._temporaries.add(s),new _(s)}defineIdentifier(e,t){const s=this._symbolTable[this._symbolTable.length-1];if(s.has(e))throw this.semanticError(`"${e}" is already declared in this scope!`);s.set(e,t)}resolveIdentifier(e){for(let t=this._symbolTable.length-1;t>=0;t--){const s=this._symbolTable[t];if(s.has(e))return s.get(e)}throw this.semanticError(`"${e}" is not declared!`)}enterScope(){this._symbolTable.push(new Map)}exitScope(){if(!this._symbolTable.length)throw new Error("Tried to exit the global scope.");this._symbolTable.pop()}isGlobal(){return 1===this._symbolTable.length}semanticError(e){return this.compiler.console.error(e),new Oe(e)}_appendToFunction(e,t){const s=this.compiler.program.blocks.get(e)||[];s.push(...t),this.compiler.program.blocks.set(e,s)}}class Oe extends Error{}class Ae extends Error{}class Ie{async readTextFile(e){const t=await this.readFile(e);return(new TextDecoder).decode(t)}async writeTextFile(e,t){const s=(new TextEncoder).encode(t);return await this.writeFile(e,s)}}const Re=new class{constructor(e=document.createElement("console-")){this.root=e}log(e){return this._append(e,"info")}error(e){return this._append(e,"error")}warn(e){return this._append(e,"warn")}clear(){return this.root.textContent="",this}_append(e,t){const s=document.createElement("div");return s.textContent=e,s.dataset.severity=t,this.root.append(s),s.scrollIntoView({block:"nearest"}),this}},$e=new class{constructor(){this.schemes=new Map}readFile(e){return this._getFileSystem(e).readFile(e)}createDirectory(e){return this._getFileSystem(e).createDirectory(e)}writeFile(e,t){return this._getFileSystem(e).writeFile(e,t)}readTextFile(e){return this._getFileSystem(e).readTextFile(e)}writeTextFile(e,t){return this._getFileSystem(e).writeTextFile(e,t)}_getFileSystem(e){const t=this.schemes.get(e.scheme);if(!t)throw new Error(`"${e.scheme}" is not a registered file system!`);return t}},Le=new class extends Ie{constructor(e=new Map){super(),this.scheme="fsa",this.onRegisterHandle=new Set,this.handles=e}registerHandle(e,t){this.handles.set(e,t);const s=new Ee(this.scheme,e);for(const e of this.onRegisterHandle)e({uri:s});return s}availableAuthority(e){let t=e,s=0;for(;this.handles.has(t);)t=`${e} ${++s}`;return t}async getURI(e){if("file"===e.kind){for(const[t,s]of this.handles)if("file"===s.kind&&await s.isSameEntry(e))return new Ee(this.scheme,t)}else for(const[t,s]of this.handles)if("directory"===s.kind){const n=await s.resolve(e);if(n)return new Ee(this.scheme,t,n)}}async readFile(e){const t=await this._getHandle(e,!1,"file"),s=await t.getFile();return await s.arrayBuffer()}async writeFile(e,t){const s=await this._getHandle(e,!0,"file"),n=await s.createWritable();await n.write(t),await n.close()}async createDirectory(e){await this._getHandle(e,!0,"directory")}async _getHandle(e,t,s){if(e.isRoot())return await this._getRoot(e,s);const n=await this._getParent(e,t);return"file"===s?await n.getFileHandle(e.filename,{create:t}):await n.getDirectoryHandle(e.filename,{create:t})}async _getRoot(e,t){const s=this.handles.get(e.authority);if(!s)throw new Error("Resource not found.");if(e.isRoot()||s.kind!==t)throw new Error("Illegal Operation!");return s}async _getParent(e,t){let s=await this._getRoot(e,"directory");for(const n of e.directory)s=await s.getDirectoryHandle(n,{create:t});return s}};Le.onRegisterHandle.add((({uri:e})=>window.console.log(`Registered handle at ${e}`))),$e.schemes.set(Le.scheme="fsa",Le);const ke=new class extends Ie{async readFile(e){const t=await fetch(e.toString(),{cache:"reload"});if(404===t.status)throw new Error(`File "${e.slug()}" not found.`);return await t.arrayBuffer()}async writeFile(){throw new Error("Failed to write file:\nFile system is read only.")}async createDirectory(){throw new Error("Failed to create directory:\nFile system is read only.")}};$e.schemes.set("http",ke),$e.schemes.set("https",ke);const Me=new Set;function Ne(e){Fe.uri=e,window.console.log(`Loaded project: ${e.toString()}`);for(const t of Me)t(e)}const Fe=new class{constructor(){this.beforeCompile=new Set,this.onLoadConfig=new Set,this.onImportModule=new Set,this.onCompile=new Set,this.onTransform=new Set,this.onGenerateCode=new Set}clear(){this.modules=new Map,this.program=new R}async compile(){try{for(const e of this.beforeCompile)e.call(this);if(!this.uri){const e="No project loaded.";throw this.console.error(e),new Ae(e)}this.clear(),this.console.log(`Compiling project: ${this.uri}`),await this._loadConfig(),function(e,t,s){if(e||s.error("Config must not be empty!"),e.entry?Ee.fromString(t.toString()+`${e.entry}`)||s.error('"config.entry" is malformed!'):s.error('"config.entry" must not be empty.'),e.destination&&!Ee.fromString(t.toString()+`${e.destination}`)&&s.error('"config.destination" is malformed!'),e.initializer)if("string"!=typeof e.initializer)s.error('"config.initializer" must be a string.');else{const t=k(e.initializer);t&&s.warn(t)}else s.error('"config.initializer" must not be empty.');if(e.destructor)if("string"!=typeof e.destructor)s.error('"config.destructor" must be a string.');else{const t=k(e.destructor);t&&s.warn(t)}else s.error('"config.destructor" must not be empty.');if(e.scoreboardNamespace)if("string"!=typeof e.scoreboardNamespace)s.error('"config.scoreboardNamespace" must be a string.');else{const t=N(e.scoreboardNamespace);t&&s.warn(t);const n=13;e.scoreboardNamespace.length>n&&s.warn(`"config.scoreboardNamespace" should be kept under ${n} characters.`)}else s.error('"config.scoreboardNamespace" must not be empty.');if(e.functionNamespace)if("string"!=typeof e.functionNamespace)s.error('"config.functionNamespace" must be a string.');else{const t=k(e.functionNamespace);t&&s.warn(t)}else s.error('"config.functionNamespace" must not be empty.');function n(e,t){if(void 0!==t)if(t instanceof Array)for(const e of t){const t=k(`${e}`);t&&s.warn(t)}else s.warn(`"${e}" must be string[] or undefined.`)}n("config.onLoad",e.onLoad),n("config.onTick",e.onTick);const r=xe("boilerplate");for(const t of Object.keys(e))t in r||s.warn(`"config.${t}" is not a known option.`)}(this.config,this.uri,this.console),this.program.config=this.config,await Ce.entry(this),this.console.log("Compilation successful!");for(const e of this.onCompile)e.call(this,this.program);const e=function(e){let t=0;for(;J(e);){if(t>=500){console.error(`Optimization exceeded ${t} cycles. This is probably a bug. Please report to a maintainer.`);break}t++}return e}(this.program);this.console.log("Code optimization successful!");for(const t of this.onTransform)t.call(this,e);const t=e.generate();this.console.log("Code generation successful!");const s=t.files();this._extraFiles(s);for(const e of this.onGenerateCode)e.call(this,s);for(const e of t.scores){const t=N(e.objective);t&&this.console.warn(t)}for(const[e]of t.mcfunctions){const t=k(e);t&&this.console.warn(t)}if(this.config.destination){const e=this.uri.clone().appendString(this.config.destination,!0);for(const[t,n]of s){const s=e.clone().appendString(t);this.console.log(`Writing file: ${t}`),await this.fileSystem.writeTextFile(s,n).catch((e=>{const t=e.message;throw this.console.error(t),new Ae(t)}))}this.console.log("Created all files successfully.")}else this.console.warn('No files were created as "config.destination" was not specified.')}catch(e){let t=!0;throw e instanceof Oe&&(t=!1),e instanceof Ae&&(t=!1),t&&this.console.error("Unexpected Error."),this.console.error("Compilation Failed!"),e}}async _loadConfig(){const e=this.uri.clone().setFilename("emcl.config.json");this.console.log(`Reading config file: ${this.uri.relativePathOf(e)}`);const t=await this.fileSystem.readTextFile(e).catch((e=>{throw this.console.error(e.message),new Ae(e.message)}));try{this.config=JSON.parse(t)}catch(e){throw window.console.log("Failed to load config file:",t),this.console.error("Config file is malformed!"),new Ae("Config file is malformed!")}for(const t of this.onLoadConfig)t.call(this,e,this.config)}async _extraFiles(e=new Map){const t=e=>JSON.stringify(e,null,"\t");return this.config.onLoad&&e.set("data/minecraft/tags/functions/load.json",t({replace:!1,values:this.config.onLoad})),this.config.onTick&&e.set("data/minecraft/tags/functions/tick.json",t({replace:!1,values:this.config.onTick})),this.config.packMeta&&e.set("pack.mcmeta",t(this.config.packMeta)),e}};async function Pe(){if(!window.showDirectoryPicker)return void alert(Ue);const e=await showDirectoryPicker().catch((()=>{}));if(!e)return;Ne(await Le.getURI(e)||Le.registerHandle(Le.availableAuthority(e.name),e))}async function ze(){Re.clear(),De(1),await Fe.compile()}Fe.console=Re,Fe.fileSystem=$e;const je=new Set;function De(e){for(const t of je)t(e)}const Ue="The File System Access API is not supported in this browser. Consider switching to a Chromium browser like Google Chrome, Opera, or Microsoft Edge.";window.showDirectoryPicker||alert(Ue);var He=Object.freeze({__proto__:null,console:Re,fileSystem:$e,fsaFileSystem:Le,onLoadProject:Me,loadProject:Ne,compiler:Fe,openLoadFSAProjectDialog:Pe,compile:ze,onOpenTab:je,openTab:De});class Ve{constructor(e=document.createElement("code-block"),t=!0){this.root=e,this._gutter=document.createElement("emcl-code-gutter"),this._content=document.createElement("emcl-code-content"),this.root.classList.add("emcl-code"),t&&(this.root.append(this._gutter),this.root.classList.add("block")),this.root.append(this._gutter,this._content)}setText(t){n.reset();const s=e.joinAdjacentTokens(n.tokenize(t),"ILLEGAL");return this.setTokens(s)}setTokens(e,t){this._content.textContent="";let s=0;for(const n of e){const e=t?.get(n),r=document.createElement("emcl-code-token");r.dataset.type=n.type,r.textContent=n.value,r.title=`${n.type}`,e&&(r.title+=`\nline: ${e.line+1}\nchar: ${e.char+1}`),this._content.appendChild(r);for(const e of n.value)"\n"===e&&s++}return this.setGutter(s)}setGutter(e){this._gutter.textContent="";for(let t=0,s=e+1;t<s;t++){const e=document.createElement("div");e.textContent=(t+1).toString(),this._gutter.append(e)}return this}}const Ge=document.createElement("div");Ge.style.padding="1em",Ge.style.overflow="auto";const Be=document.createElement("div");Be.style.margin="auto",Be.style.width="800px",Ge.append(Be),(async()=>{const e=await fetch("./assets/info.html");Be.innerHTML=await e.text();for(const e of Be.querySelectorAll("code-block.emcl"))e.replaceWith((new Ve).setText(e.textContent??"").root)})();const We=document.createElement("div");We.style.overflow="auto",Fe.beforeCompile.add((()=>{We.textContent=""})),Fe.onLoadConfig.add(((e,t)=>{const s=document.createElement("details");s.classList.add("app-collapsible-panel");const n=document.createElement("summary");n.textContent=Fe.uri.relativePathOf(e);const r=document.createElement("code-block");r.style.whiteSpace="pre",r.textContent=JSON.stringify(t,null,"\t"),s.append(n,r),s.open=!0,We.append(s)})),Fe.onImportModule.add(((e,t)=>{const s=document.createElement("details");s.classList.add("app-collapsible-panel");const n=document.createElement("summary");n.textContent=Fe.uri.relativePathOf(e);const r=new Ve;r.setTokens(t.tokens,t.tokenMap),s.append(n,r.root),s.open=!0,We.append(s)}));const qe=document.createElement("div");Object.assign(qe.style,{display:"grid",gridTemplateColumns:"var(--navigation-rail-width) auto",overflow:"hidden"}),qe.innerHTML='\n\t<navigation-rail>\n\t\t<div class="center-content"><i class="fa fa-file"  \t\t\ttitle="Files"></i></div>\n\t\t<div class="center-content"><i class="fa fa-microchip"  \ttitle="MIL"></i></div>\n\t\t<div class="center-content"><i class="fa fa-bolt"  \t\t\ttitle="Optimized MIL"></i></div>\n\t</navigation-rail>\n\t<div class="expand-children"></div>\n';const Je=[document.createElement("div"),document.createElement("div"),document.createElement("div")];for(const e of Je)e.style.overflow="auto";const Qe=qe.children[0].children,Ye=qe.children[1];for(let e=0;e<Qe.length;e++)Qe[e].onclick=()=>Ze(e);function Ze(e){Ye.textContent="",Ye.append(Je[e]);for(const t of Qe)t.classList.toggle("selected",t===Qe[e])}function Xe(e,t){e.textContent="";for(const[s,n]of[...t.blocks].reverse()){const t=document.createElement("details");t.classList.add("app-collapsible-panel");const r=document.createElement("summary");r.textContent=s;const i=new Ve;i.setText(n.map((e=>e.serialize())).join("\n")),t.append(r,i.root),t.open=!0,e.append(t)}}Ze(0),Fe.onCompile.add((e=>Xe(Je[1],e))),Fe.onTransform.add((e=>Xe(Je[2],e))),Fe.onGenerateCode.add((e=>{const t=Je[0];t.textContent="";for(const[s,n]of[...e].sort()){const e=document.createElement("details");e.classList.add("app-collapsible-panel");const r=document.createElement("summary");r.textContent=s;const i=document.createElement("code-block");i.style.whiteSpace="pre",i.textContent=n,e.append(r,i),e.open=!0,t.append(e)}}));const Ke=[Ge,Re.root,We,qe],et=document.querySelector("tabs-").children,tt=document.querySelector("#panelContainer");for(let e=0;e<et.length;e++)et[e].onclick=()=>De(e);je.add((e=>{for(const t of et)t.classList.toggle("selected",t===et[e]);tt.innerHTML="",tt.appendChild(Ke[e])})),De(0);const st=document.querySelector("#loadProject"),nt=document.querySelector("#compile");st.onclick=()=>Pe(),nt.onclick=()=>ze();const rt=document.querySelector("#install");function it(){const e=new URLSearchParams(location.hash.substr(1)).get("source-url");if(e){const t=new Ee;try{t.setString(location.href),t.appendString(e)}catch(e){return void console.log("Source URI provided by URL fragment is malformed.")}Ne(t),ze(),De(2)}}window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),rt.style.display="",rt.onclick=async()=>{e.prompt(),await e.userChoice,rt.style.display="none"}})),Me.add((e=>{const t=e.clone().appendString("emcl.config.json");$e.readTextFile(t).catch((async()=>{if(!confirm("A config file was not found. Would you like to create one?"))return;Re.clear(),De(1);const t=function(e){const t=new Map;return t.set("emcl.config.json",JSON.stringify(e,null,"\t")),t.set(e.entry,""),e.destination&&t.set(e.destination,void 0),t}(xe(e.slug().trim().split(/\s+|(?=[A-Z])/).join("_").toLowerCase()));for(const[s,n]of t){const t=e.clone().appendString(s);void 0!==n?await $e.readFile(t).catch((async()=>{await $e.writeTextFile(t,n),Re.log(`Created file: ${s}`)})):(await $e.createDirectory(t),Re.log(`Created directory: ${s}`))}}))})),window.app=He,console.log('For debugging, see "window.app"'),addEventListener("hashchange",(()=>it())),it()}();
//# sourceMappingURL=main.js.map
